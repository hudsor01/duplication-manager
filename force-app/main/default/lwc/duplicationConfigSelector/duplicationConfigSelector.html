<template>
  <!-- Loading Spinner -->
  <template if:true={isLoading}>
    <lightning-spinner
      alternative-text="Loading configurations"
      size="small"
    ></lightning-spinner>
  </template>

  <div class="slds-var-p-around_medium">
    <!-- Error Display -->
    <template if:true={hasError}>
      <div class="slds-text-color_error slds-var-p-around_small">
        <lightning-icon
          icon-name="utility:warning"
          alternative-text="Error"
          size="small"
          class="slds-var-m-right_x-small"
        ></lightning-icon>
        <span>{error.message}</span>
      </div>
    </template>

    <!-- Configuration Selection Section -->
    <div
      class="slds-form slds-form_stacked"
      role="region"
      aria-labelledby="config-heading"
    >
      <h2
        id="config-heading"
        class="slds-text-heading_small slds-var-m-bottom_small"
      >
        Duplication Detection Configuration
      </h2>

      <!-- No Configurations Message -->
      <template if:false={hasConfigurations}>
        <div class="slds-box slds-theme_info slds-var-p-around_medium">
          <h3 class="slds-text-heading_small slds-var-m-bottom_small">
            No Active Duplication Finder Settings Found
          </h3>
          <p>
            The Duplication Manager requires custom metadata configuration to be
            deployed to your org.
          </p>

          <div class="slds-text-align_left slds-var-m-top_medium">
            <ol class="slds-list_ordered">
              <li class="slds-var-m-bottom_x-small">
                Ensure the DuplicationFinderSetting__mdt custom metadata type
                exists in your org
              </li>
              <li class="slds-var-m-bottom_x-small">
                Verify you have at least one record with IsActive__c = true
              </li>
              <li class="slds-var-m-bottom_x-small">
                Deploy the components by right-clicking the "customMetadata"
                folder in VS Code and selecting "Deploy Source to Org"
              </li>
            </ol>
          </div>

          <div class="slds-var-m-top_medium slds-text-align_center">
            <lightning-button
              label="Open Setup Guide"
              variant="brand"
              onclick={handleViewGuide}
            ></lightning-button>
          </div>
        </div>
      </template>

      <!-- Configuration Dropdown -->
      <template if:true={hasConfigurations}>
        <div class="slds-form-element config-selector-container">
          <div class="slds-form-element__control">
            <lightning-combobox
              name="configuration"
              label="Select Configuration"
              variant="standard"
              placeholder="--Select a Configuration--"
              value={selectedConfigId}
              options={configOptions}
              onchange={handleConfigChange}
              dropdown-alignment="auto"
              class="config-selector-combobox"
            >
            </lightning-combobox>
          </div>
        </div>

        <!-- Recent Configurations -->
        <template if:true={hasRecentConfigurations}>
          <div class="slds-var-m-top_small">
            <p class="slds-text-title slds-var-m-bottom_xx-small">
              Recent Configurations
            </p>
            <div class="slds-var-p-vertical_x-small">
              <template for:each={recentConfigurations} for:item="config">
                <span
                  key={config.DeveloperName}
                  class="slds-var-m-right_xx-small slds-var-m-bottom_xx-small"
                  data-id={config.DeveloperName}
                  onclick={handleRecentSelection}
                >
                  <span class="">{config.MasterLabel}</span>
                </span>
              </template>
            </div>
          </div>
        </template>
      </template>

      <!-- Custom Field Selection -->
      <template if:true={hasSelectedConfiguration}>
        <div class="slds-var-m-top_medium">
          <lightning-input
            type="checkbox"
            label="Customize Field Selection"
            checked={useCustomConfig}
            onchange={handleCustomConfigChange}
          >
          </lightning-input>
        </div>
      </template>

      <!-- Custom Field Selection Panel -->
      <template if:true={showCustomFieldPanel}>
        <div
          class="slds-box slds-theme_default slds-var-m-top_medium custom-field-selection-panel"
        >
          <div
            class="slds-grid slds-grid_vertical-align-center slds-var-m-bottom_medium"
          >
            <div class="slds-col">
              <h2 class="slds-text-heading_medium">
                <lightning-icon
                  icon-name="utility:filter"
                  size="small"
                  class="slds-var-m-right_x-small"
                  variant="brand"
                ></lightning-icon>
                Custom Matching Fields
              </h2>
              <p class="slds-text-body_small slds-var-m-top_xx-small">
                Select which fields to use for finding duplicate records
              </p>
            </div>
            <div class="slds-col slds-text-align_right">
              <div class="slds-button-group">
                <lightning-button-icon
                  icon-name="utility:filterList"
                  variant="border-filled"
                  alternative-text="Select All"
                  title="Select All"
                  onclick={handleSelectAll}
                  class="slds-var-m-right_xx-small"
                >
                </lightning-button-icon>
                <lightning-button-icon
                  icon-name="utility:clear"
                  variant="border-filled"
                  alternative-text="Clear All"
                  title="Clear All"
                  onclick={handleClearAll}
                >
                </lightning-button-icon>
              </div>
            </div>
          </div>

          <!-- Field Type Filters -->
          <div
            class="slds-grid slds-grid_vertical-align-center slds-var-m-bottom_small"
          >
            <div class="slds-col">
              <div class="slds-button-group field-type-filters">
                <button
                  class="slds-button slds-button_neutral filter-all-btn active-filter"
                  onclick={handleFilterAll}
                >
                  All
                </button>
                <button
                  class="slds-button slds-button_neutral filter-standard-btn"
                  onclick={handleFilterStandard}
                >
                  Standard
                </button>
                <button
                  class="slds-button slds-button_neutral filter-text-btn"
                  onclick={handleFilterText}
                >
                  Text Fields
                </button>
                <button
                  class="slds-button slds-button_neutral filter-contact-btn"
                  onclick={handleFilterContact}
                >
                  Contact Info
                </button>
                <button
                  class="slds-button slds-button_neutral filter-address-btn"
                  onclick={handleFilterAddress}
                >
                  Address
                </button>
              </div>
            </div>
            <div class="slds-col slds-text-align_right">
              <lightning-input
                type="search"
                label="Search fields"
                variant="label-hidden"
                placeholder="Search fields..."
                onchange={handleFieldSearch}
                class="field-search"
              >
              </lightning-input>
            </div>
          </div>

          <!-- Field Selection Area -->
          <div class="field-selection-area slds-var-p-around_small">
            <template if:true={isLoadingFields}>
              <div class="slds-var-p-around_medium slds-text-align_center">
                <lightning-spinner
                  alternative-text="Loading fields"
                  size="small"
                ></lightning-spinner>
                <p class="slds-var-p-top_small">Loading fields...</p>
              </div>
            </template>

            <template if:false={isLoadingFields}>
              <div class="selected-fields-summary slds-var-m-bottom_small">
                <div class="slds-grid slds-grid_vertical-align-center">
                  <div class="slds-col">
                    <span class="slds-badge slds-badge_lightest">
                      {selectedFieldsCount} of {totalFieldsCount} fields
                      selected
                    </span>
                  </div>
                  <div class="slds-col slds-text-align_right">
                    <lightning-button
                      variant="neutral"
                      label="Reset to Default"
                      icon-name="utility:undo"
                      onclick={handleResetFields}
                      class="slds-var-m-right_x-small"
                    >
                    </lightning-button>
                  </div>
                </div>
              </div>

              <div
                class="field-grid slds-scrollable_y"
                style="max-height: 300px; overflow-y: auto"
              >
                <lightning-layout multiple-rows>
                  <template for:each={filteredFields} for:item="field">
                    <lightning-layout-item
                      key={field.apiName}
                      size="6"
                      padding="horizontal-small"
                    >
                      <div
                        class="field-item slds-var-p-around_xx-small"
                        data-type={field.type}
                      >
                        <lightning-input
                          type="checkbox"
                          label={field.label}
                          data-field={field.apiName}
                          checked={field.selected}
                          onchange={handleFieldSelection}
                        >
                        </lightning-input>
                        <span class="field-type-badge">{field.typeLabel}</span>
                      </div>
                    </lightning-layout-item>
                  </template>
                </lightning-layout>

                <template if:true={noFieldsToShow}>
                  <div class="slds-var-p-around_medium slds-text-align_center">
                    <div class="slds-illustration slds-illustration_small">
                      <lightning-icon
                        icon-name="utility:filter"
                        size="medium"
                        class="slds-var-m-bottom_small"
                      ></lightning-icon>
                      <h3 class="slds-text-heading_small">
                        No fields match your filter
                      </h3>
                      <p class="slds-text-body_small">
                        Try adjusting your search or filters
                      </p>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>

          <!-- Action Buttons -->
          <div
            class="action-buttons slds-var-m-top_medium slds-border_top slds-var-p-top_medium"
          >
            <div class="slds-grid slds-grid_align-spread">
              <div class="slds-col">
                <div class="selection-help">
                  <lightning-icon
                    icon-name="utility:info"
                    size="x-small"
                    class="slds-var-m-right_x-small"
                  ></lightning-icon>
                  <span class="slds-text-body_small"
                    >Choose the most reliable fields for identifying
                    duplicates</span
                  >
                </div>
              </div>
              <div class="slds-col slds-text-align_right">
                <lightning-button
                  variant="neutral"
                  label="Cancel"
                  onclick={handleCancelCustomConfig}
                  class="slds-var-m-right_small"
                >
                </lightning-button>
                <lightning-button
                  variant="brand"
                  label="Apply Selection"
                  icon-name="utility:check"
                  onclick={handleApplyCustomConfig}
                  disabled={isApplyDisabled}
                  class="slds-var-m-right_small"
                >
                </lightning-button>
                <lightning-button
                  variant="success"
                  label="Find Duplicates Now"
                  icon-name="utility:search"
                  onclick={handleFindDuplicatesNow}
                  disabled={isApplyDisabled}
                >
                </lightning-button>
              </div>
            </div>
          </div>
        </div>
      </template>

      <!-- Selected Configuration Details -->
      <template if:true={hasSelectedConfiguration}>
        <div class="slds-box slds-theme_shade slds-var-m-top_medium">
          <div class="slds-text-title slds-var-m-bottom_small">
            Configuration Details
          </div>
          <lightning-layout multiple-rows>
            <lightning-layout-item size="6" padding="horizontal-small">
              <p>
                <strong>Object:</strong> {selectedConfiguration.ObjectApiName}
              </p>
              <p>
                <strong>Match Fields:</strong>
                {displayMatchFields}
              </p>
            </lightning-layout-item>
            <lightning-layout-item size="6" padding="horizontal-small">
              <p>
                <strong>Master Record Strategy:</strong>
                {selectedConfiguration.MasterRecordStrategy}
              </p>
              <p>
                <strong>Batch Size:</strong> {selectedConfiguration.BatchSize}
              </p>
            </lightning-layout-item>
          </lightning-layout>

          <!-- Tooltips and Help Text -->
          <div class="slds-var-m-top_small slds-text-body_small">
            <div
              class="slds-box slds-theme_info slds-var-p-around_small slds-text-align_left"
            >
              <p>
                <lightning-icon
                  icon-name="utility:info_alt"
                  size="xx-small"
                  class="slds-var-m-right_xx-small"
                ></lightning-icon>
                <strong>Master Record Strategy:</strong> Determines which record
                becomes the "master" during merge.
              </p>
              <div class="slds-var-m-left_small slds-var-m-top_xx-small">
                <p>
                  <strong>Most Complete:</strong> Record with the most non-empty
                  field values
                </p>
                <p>
                  <strong>Most Recent:</strong> Record with the most recent Last
                  Modified Date
                </p>
                <p>
                  <strong>Oldest Record:</strong> Record with the oldest Created
                  Date
                </p>
              </div>

              <p class="slds-var-m-top_small">
                <lightning-icon
                  icon-name="utility:info_alt"
                  size="xx-small"
                  class="slds-var-m-right_xx-small"
                ></lightning-icon>
                <strong>Match Fields:</strong> Fields used to determine if
                records are duplicates.
              </p>
              <div class="slds-var-m-left_small slds-var-m-top_xx-small">
                <p><strong>How matching works:</strong></p>
                <ol class="slds-list_ordered">
                  <li>
                    Records are compared using advanced fuzzy matching
                    algorithms
                  </li>
                  <li>
                    Each field is evaluated independently with appropriate
                    techniques:
                    <ul class="slds-list_dotted slds-var-m-left_small">
                      <li>
                        <strong>Email:</strong> Normalized for case and common
                        variations
                      </li>
                      <li>
                        <strong>Phone:</strong> Compared after removing
                        formatting characters
                      </li>
                      <li>
                        <strong>Names:</strong> Fuzzy matching for typos and
                        variations
                      </li>
                      <li>
                        <strong>Addresses:</strong> Component-wise comparison
                        (street, city, etc.)
                      </li>
                    </ul>
                  </li>
                  <li>
                    A match score is calculated based on field similarities
                  </li>
                  <li>
                    Records above the match threshold are grouped as duplicates
                  </li>
                </ol>
                <p class="slds-var-m-top_xx-small">
                  <lightning-button
                    variant="brand-outline"
                    label="View Documentation"
                    icon-name="utility:knowledge_base"
                    class="slds-var-m-top_x-small"
                    onclick={handleViewDocs}
                  >
                  </lightning-button>
                </p>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>
  </div>
</template>
