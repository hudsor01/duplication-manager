<template>
  <lightning-card title="Duplicate Record Manager" icon-name="standard:merge">
    <!-- Loading Spinner -->
    <template if:true={isLoading}>
      <lightning-spinner
        alternative-text="Loading"
        size="medium"
      ></lightning-spinner>
    </template>

    <div class="slds-var-p-around_medium">
      <!-- Introduction Card -->
      <div class="slds-box slds-theme_shade slds-var-m-bottom_medium">
        <div class="slds-grid slds-grid_vertical-align-center">
          <div class="slds-col slds-size_1-of-1">
            <h2 class="slds-text-heading_small slds-var-m-bottom_x-small">
              Welcome to the Duplicate Record Manager
            </h2>
            <p class="slds-text-body_small">
              This tool helps you find and merge duplicate records across your
              Salesforce organization. Supported objects include Accounts,
              Contacts, Leads, and more.
            </p>
            <p class="slds-text-body_small slds-var-m-top_x-small">
              <strong>Key Features:</strong>
              <span class="slds-var-m-left_x-small"
                >✓ Find duplicates based on configurable matching fields</span
              >
              <span class="slds-var-m-left_x-small"
                >✓ Merge records with conflict resolution</span
              >
              <span class="slds-var-m-left_x-small"
                >✓ Schedule regular deduplication jobs</span
              >
              <span class="slds-var-m-left_x-small"
                >✓ Verify results with Dry Run mode</span
              >
            </p>
          </div>
        </div>
      </div>

      <!-- Error Display -->
      <template if:true={hasError}>
        <div class="slds-text-color_error slds-var-p-around_small">
          <lightning-icon
            icon-name="utility:error"
            alternative-text="Error"
            size="small"
            class="slds-var-m-right_x-small"
          ></lightning-icon>
          <span>{error.message}</span>
        </div>
      </template>

      <!-- Draft Job Banner (if available) -->
      <template if:true={hasDraftJob}>
        <div class="slds-notify slds-notify_alert slds-theme_info" role="alert">
          <span class="slds-assistive-text">Info</span>
          <lightning-icon
            icon-name="utility:info"
            alternative-text="Info"
            class="slds-var-m-right_x-small"
          ></lightning-icon>
          <h2>
            You have a draft job saved for {draftJobLabel}.
            <lightning-button-group class="slds-var-m-left_small">
              <lightning-button
                label="Resume"
                variant="brand"
                onclick={loadDraftJob}
              >
              </lightning-button>
              <lightning-button
                label="Discard"
                variant="destructive"
                onclick={clearDraftJob}
              >
              </lightning-button>
            </lightning-button-group>
          </h2>
        </div>
      </template>

      <!-- Settings Selection Section -->
      <div
        class="slds-form slds-form_stacked"
        role="region"
        aria-labelledby="settings-heading"
      >
        <h2 id="settings-heading" class="slds-assistive-text">
          Duplicate Detection Settings
        </h2>
        <div class="slds-form-element">
          <div class="slds-form-element__control">
            <lightning-combobox
              name="setting"
              label="Select Configuration"
              variant="standard"
              placeholder="--Select a Configuration--"
              value={selectedSettingId}
              options={settingOptions}
              onchange={handleSettingChange}
            >
            </lightning-combobox>
          </div>
        </div>

        <!-- Display Selected Setting Details -->
        <template if:true={selectedSetting}>
          <div class="slds-box slds-theme_shade slds-var-m-top_medium">
            <lightning-layout multiple-rows>
              <lightning-layout-item size="6" padding="horizontal-small">
                <p><strong>Object:</strong> {selectedSetting.ObjectApiName}</p>
                <p>
                  <strong>Match Fields:</strong> {selectedSetting.MatchFields}
                </p>
              </lightning-layout-item>
              <lightning-layout-item size="6" padding="horizontal-small">
                <p>
                  <strong>Master Record Strategy:</strong>
                  {selectedSetting.MasterRecordStrategy}
                </p>
                <p><strong>Batch Size:</strong> {selectedSetting.BatchSize}</p>
              </lightning-layout-item>
            </lightning-layout>
          </div>
        </template>

        <!-- Health Check Component -->
        <div class="slds-var-m-top_medium">
          <c-duplication-health-check
            config-id={selectedSettingId}
            object-api-name={selectedSetting.ObjectApiName}
            batch-size={selectedSetting.BatchSize}
            match-fields={selectedSetting.MatchFields}
            onhealthcheckcomplete={handleHealthCheckComplete}
          >
          </c-duplication-health-check>
        </div>
      </div>

      <!-- Action Buttons with Help Text -->
      <div class="slds-box slds-var-m-top_medium">
        <div class="slds-grid slds-grid_vertical">
          <div class="slds-col slds-var-m-bottom_medium">
            <div
              class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center"
            >
              <div class="slds-col slds-size_2-of-3">
                <h3 class="slds-text-heading_small">
                  Find Duplicates (Dry Run)
                </h3>
                <p class="slds-text-body_small slds-var-m-top_xx-small">
                  Identifies potential duplicate records without performing any
                  merges. Use this first to review what would be merged.
                </p>
              </div>
              <div class="slds-col slds-size_1-of-3 slds-text-align_right">
                <lightning-button
                  label="Run Dry Run"
                  variant="brand"
                  icon-name="utility:search"
                  onclick={handleDryRun}
                  disabled={isButtonDisabled}
                  access-key="d"
                >
                </lightning-button>
              </div>
            </div>
          </div>

          <div class="slds-col slds-var-m-bottom_medium">
            <div
              class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center"
            >
              <div class="slds-col slds-size_2-of-3">
                <h3 class="slds-text-heading_small">
                  Merge Duplicates (Live Run)
                </h3>
                <p class="slds-text-body_small slds-var-m-top_xx-small">
                  Identifies and merges duplicate records. This is a permanent
                  action that will combine matched records across your entire
                  organization.
                </p>
              </div>
              <div class="slds-col slds-size_1-of-3 slds-text-align_right">
                <lightning-button
                  label="Run Merge"
                  variant="destructive"
                  icon-name="utility:merge"
                  onclick={handleRunMerge}
                  disabled={isButtonDisabled}
                  access-key="m"
                >
                </lightning-button>
              </div>
            </div>
          </div>

          <div class="slds-col">
            <div
              class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center"
            >
              <div class="slds-col slds-size_2-of-3">
                <h3 class="slds-text-heading_small">
                  Schedule Regular Cleanup
                </h3>
                <p class="slds-text-body_small slds-var-m-top_xx-small">
                  Set up recurring deduplication jobs to keep your data clean.
                  You can schedule dry runs or live merges at specific times.
                </p>
              </div>
              <div class="slds-col slds-size_1-of-3 slds-text-align_right">
                <lightning-button
                  label="Schedule Job"
                  variant="success"
                  icon-name="utility:clock"
                  onclick={openScheduleModal}
                  disabled={isButtonDisabled}
                  access-key="s"
                >
                </lightning-button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dry Run Results Component -->
      <div class="slds-var-m-top_medium">
        <c-duplication-dry-run-result config-id={selectedSettingId}>
        </c-duplication-dry-run-result>
      </div>

      <!-- Jobs List Child Component -->
      <c-duplication-manager-jobs
        jobs={scheduledJobs}
        ondelete={handleJobDeleted}
        onjobcomplete={handleJobCompleted}
        onmergerequest={handleMergeRequest}
      >
      </c-duplication-manager-jobs>
    </div>

    <!-- Schedule Modal Child Component -->
    <template if:true={isScheduleModalOpen}>
      <c-duplication-manager-scheduler
        setting={selectedSetting}
        onclose={closeScheduleModal}
        onschedule={handleScheduleJob}
      >
      </c-duplication-manager-scheduler>
    </template>

    <!-- Confirmation Modal -->
    <div class={confirmationModalClass} role="dialog" tabindex="-1">
      <div class="slds-modal__container">
        <header class="slds-modal__header">
          <h2 class="slds-text-heading_medium slds-hyphenate">Confirmation</h2>
        </header>
        <div class="slds-modal__content slds-var-p-around_medium">
          <p>{confirmationMessage}</p>
        </div>
        <footer class="slds-modal__footer">
          <lightning-button
            label="Cancel"
            variant="neutral"
            onclick={handleCancelMerge}
            class="slds-var-m-right_x-small"
          >
          </lightning-button>
          <lightning-button
            label="Confirm"
            variant="brand"
            onclick={handleConfirmMerge}
          >
          </lightning-button>
        </footer>
      </div>
    </div>
    <div class={confirmationBackdropClass}></div>
  </lightning-card>
</template>
